// Professional AI Image Generation System
// Stage 1: Gemini analyzes and creates professional prompt
// Stage 2: Imagen generates high-quality image

const { GoogleGenerativeAI, ImageGenerateContentRequest } = require('@google/generative-ai');

// Initialize Gemini for both text and image generation
const genAI = new GoogleGenerativeAI(GEMINI_API_KEY);

// Helper: Validate and format Brazilian WhatsApp
const validateWhatsAppBR = (whatsapp) => {
  if (!whatsapp) return null;
  const cleaned = whatsapp.replace(/\D/g, '');
  
  if (cleaned.length === 13 && cleaned.startsWith('55')) {
    const ddd = cleaned.substring(2, 4);
    const number = cleaned.substring(4);
    if (number.length === 9 && number.startsWith('9')) {
      return `+55 ${ddd} ${number.substring(0, 5)}-${number.substring(5)}`;
    }
  } else if (cleaned.length === 11) {
    const ddd = cleaned.substring(0, 2);
    const number = cleaned.substring(2);
    if (number.length === 9 && number.startsWith('9')) {
      return `+55 ${ddd} ${number.substring(0, 5)}-${number.substring(5)}`;
    }
  }
  
  return null;
};

// STAGE 1: Gemini Analyzes Client Input and Creates Professional Prompt
app.post('/api/ai/analyze-prompt', async (req, res) => {
  try {
    const { companyName, details, addressCity, phone, userPrompt } = req.body;
    
    if (!companyName || !userPrompt) {
      return res.status(400).json({ error: 'Nome da empresa e descri√ß√£o s√£o obrigat√≥rios' });
    }

    const model = genAI.getGenerativeModel({ model: "gemini-1.5-flash" });
    
    // Validate WhatsApp
    const validatedPhone = phone ? validateWhatsAppBR(phone) : null;
    const phoneWarning = phone && !validatedPhone ? 'ATEN√á√ÉO: WhatsApp inv√°lido ou fora do padr√£o brasileiro' : null;
    
    const systemPrompt = `Voc√™ √© um especialista em marketing visual e design gr√°fico para o mercado brasileiro. Sua miss√£o √© transformar pedidos simples de clientes em prompts extremamente detalhados e profissionais para gera√ß√£o de imagens comerciais de alta qualidade.

DADOS DO CLIENTE:
- Empresa: ${companyName}
- Detalhes: ${details || 'N√£o fornecido'}
- Cidade: ${addressCity || 'N√£o fornecido'}
- WhatsApp: ${validatedPhone || 'N√£o fornecido'}
- Pedido do Cliente: "${userPrompt}"

TAREFA:
Analise o pedido do cliente e crie um prompt EXTREMAMENTE DETALHADO para gerar uma arte comercial profissional. O prompt deve ser em INGL√äS (para melhor qualidade da IA de imagem) e incluir:

1. **Estilo Visual**: Moderno, clean, premium, vibrante, minimalista, etc.
2. **Layout**: Composi√ß√£o, hierarquia visual, espa√ßos em branco
3. **Cores**: Paleta harmoniosa adequada ao nicho
4. **Tipografia**: Fontes leg√≠veis, pesos, tamanhos
5. **Elementos Visuais**: √çcones, formas, texturas
6. **Texto na Imagem**: 
   - Nome da empresa em destaque
   - WhatsApp formatado corretamente (se fornecido)
   - CTA (Call-to-Action) persuasivo
   - Endere√ßo/cidade (se fornecido)
7. **P√∫blico-Alvo**: Brasileiro, linguagem local
8. **Qualidade**: Alta resolu√ß√£o, profissional, pronto para redes sociais

REGRAS CR√çTICAS:
- O prompt DEVE ser em INGL√äS para melhor qualidade
- Inclua "high quality, professional, 8k, sharp details"
- Especifique "Brazilian Portuguese text" para textos
- Se o WhatsApp for inv√°lido, N√ÉO inclua no prompt
- Adapte o estilo ao nicho do neg√≥cio
- Seja MUITO espec√≠fico sobre cores, fontes e layout

FORMATO DE RESPOSTA (JSON):
{
  "analysisNotes": "An√°lise do pedido do cliente em portugu√™s",
  "suggestedStyle": "Estilo sugerido (ex: moderno, clean, vibrante)",
  "colorPalette": ["#hex1", "#hex2", "#hex3"],
  "finalPrompt": "PROMPT DETALHADO EM INGL√äS AQUI",
  "warnings": ["Avisos sobre dados faltantes ou inv√°lidos"],
  "estimatedQuality": "Alta | M√©dia | Baixa"
}

Retorne APENAS o JSON, sem markdown.`;

    const result = await model.generateContent(systemPrompt);
    const response = await result.response;
    let analysisText = response.text().trim();
    
    // Remove markdown code blocks
    analysisText = analysisText.replace(/```json\n?/g, '').replace(/```\n?/g, '');
    
    try {
      const analysis = JSON.parse(analysisText);
      
      // Add phone warning if needed
      if (phoneWarning && !analysis.warnings) {
        analysis.warnings = [phoneWarning];
      } else if (phoneWarning) {
        analysis.warnings.push(phoneWarning);
      }
      
      res.json({ 
        success: true,
        analysis,
        validatedPhone
      });
    } catch (parseError) {
      console.error('Failed to parse Gemini analysis:', analysisText);
      res.status(500).json({ 
        error: 'Falha ao analisar resposta da IA',
        rawResponse: analysisText 
      });
    }
  } catch (error) {
    console.error('‚ùå Analysis error:', error);
    res.status(500).json({ error: 'Falha ao analisar prompt: ' + error.message });
  }
});

// STAGE 2: Generate Professional Image with Imagen
app.post('/api/ai/generate-professional-image', async (req, res) => {
  try {
    const user = await getAuthUser(req);
    if (!user) return res.status(401).json({ error: 'N√£o autorizado' });

    const { finalPrompt, companyName, details, addressCity, phone, analysis } = req.body;
    
    if (!finalPrompt) {
      return res.status(400).json({ error: 'Prompt profissional √© obrigat√≥rio' });
    }

    // Fetch user role
    const { data: profile } = await supabase.from('profiles').select('role').eq('id', user.id).single();
    const role = profile?.role || 'free';

    // UNLIMITED GENERATION FOR OWNER AND DEV
    const hasUnlimitedGeneration = role === 'owner' || role === 'dev';

    if (!hasUnlimitedGeneration) {
      // Check Quota
      const { data: usageData, error: usageError } = await supabase
        .from('user_usage')
        .select('*')
        .eq('user_id', user.id)
        .single();

      if (usageError && usageError.code !== 'PGRST116') throw usageError;

      const limit = role === 'pro' ? 1000 : (role === 'starter' ? 100 : 5);

      if (usageData && usageData.images_generated >= limit) {
        return res.status(403).json({
          error: 'Limite de gera√ß√£o atingido.',
          quotaStatus: 'BLOCKED',
          usage: usageData.images_generated,
          plan: role
        });
      }
    }

    console.log(`üé® Generating professional image for ${role} user:`, user.id);
    console.log(`üìù Using Imagen with prompt:`, finalPrompt.substring(0, 100) + '...');

    // Generate image with Imagen 3.0
    const imageModel = genAI.getGenerativeModel({ model: "imagen-3.0-generate-001" });
    
    const imageResult = await imageModel.generateImages({
      prompt: finalPrompt,
      numberOfImages: 1,
      // Optional: enhance prompt for better quality
      // enhancePrompt: true
    });

    if (!imageResult || !imageResult.images || imageResult.images.length === 0) {
      throw new Error('Nenhuma imagem foi gerada pela IA');
    }

    // Get the generated image (base64)
    const generatedImage = imageResult.images[0];
    const imageBase64 = generatedImage.image; // Base64 string
    
    // Convert to data URL
    const imageUrl = `data:image/png;base64,${imageBase64}`;

    // Save to Database
    const { data: savedImage, error: saveError } = await supabase
      .from('images')
      .insert({
        user_id: user.id,
        prompt: finalPrompt,
        image_url: imageUrl, // Store base64 data URL
        business_info: {
          companyName,
          details,
          addressCity,
          phone,
          analysis
        }
      })
      .select()
      .single();

    if (saveError) {
      console.error('‚ùå Database error:', saveError);
      throw saveError;
    }

    console.log('‚úÖ Professional image saved:', savedImage.id);

    // Update Usage (only for non-unlimited users)
    if (!hasUnlimitedGeneration) {
      const { data: usageData } = await supabase
        .from('user_usage')
        .select('*')
        .eq('user_id', user.id)
        .single();

      if (usageData) {
        await supabase.from('user_usage').update({ 
          images_generated: usageData.images_generated + 1 
        }).eq('user_id', user.id);
      } else {
        await supabase.from('user_usage').insert({ 
          user_id: user.id, 
          images_generated: 1 
        });
      }
      console.log('‚úÖ Usage updated');
    } else {
      console.log('‚ú® Unlimited generation - quota not updated');
    }

    res.json({ 
      success: true,
      image: savedImage 
    });

  } catch (error) {
    console.error('‚ùå Generation error:', error);
    console.error('Error message:', error.message);
    if (error.details) console.error('Error details:', error.details);
    res.status(500).json({ 
      error: 'Falha ao gerar imagem profissional: ' + (error.message || 'Erro desconhecido') 
    });
  }
});

// COMBINED ENDPOINT: Analyze + Generate in one call
app.post('/api/ai/analyze-and-generate', async (req, res) => {
  try {
    const user = await getAuthUser(req);
    if (!user) return res.status(401).json({ error: 'N√£o autorizado' });

    const { companyName, details, addressCity, phone, userPrompt } = req.body;
    
    // Stage 1: Analyze
    console.log('üîç Stage 1: Analyzing client input...');
    const analysisResponse = await fetch(`${req.protocol}://${req.get('host')}/api/ai/analyze-prompt`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({ companyName, details, addressCity, phone, userPrompt })
    });
    
    const analysisData = await analysisResponse.json();
    
    if (!analysisData.success) {
      return res.status(500).json({ error: 'Falha na an√°lise do prompt' });
    }
    
    // Stage 2: Generate
    console.log('üé® Stage 2: Generating professional image...');
    const generateResponse = await fetch(`${req.protocol}://${req.get('host')}/api/ai/generate-professional-image`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': req.headers.authorization
      },
      body: JSON.stringify({
        finalPrompt: analysisData.analysis.finalPrompt,
        companyName,
        details,
        addressCity,
        phone: analysisData.validatedPhone,
        analysis: analysisData.analysis
      })
    });
    
    const generateData = await generateResponse.json();
    
    if (!generateData.success) {
      return res.status(500).json({ error: generateData.error || 'Falha na gera√ß√£o da imagem' });
    }
    
    res.json({
      success: true,
      analysis: analysisData.analysis,
      image: generateData.image
    });
    
  } catch (error) {
    console.error('‚ùå Analyze and generate error:', error);
    res.status(500).json({ error: 'Falha no processo completo: ' + error.message });
  }
});
