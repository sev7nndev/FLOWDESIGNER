// 2. AI: Image Generation (Pollinations.ai)
app.post('/api/generate', async (req, res) => {
  try {
    const user = await getAuthUser(req);
    if (!user) return res.status(401).json({ error: 'N√£o autorizado' });

    const { promptInfo, artStyle } = req.body;

    // Fetch user role
    const { data: profile } = await supabase.from('profiles').select('role').eq('id', user.id).single();
    const role = profile?.role || 'free';

    // UNLIMITED GENERATION FOR OWNER AND DEV
    const hasUnlimitedGeneration = role === 'owner' || role === 'dev';

    if (!hasUnlimitedGeneration) {
      // 1. Check Quota for regular users
      const { data: usageData, error: usageError } = await supabase
        .from('user_usage')
        .select('*')
        .eq('user_id', user.id)
        .single();

      if (usageError && usageError.code !== 'PGRST116') throw usageError;

      // Fetch plan limits
      const limit = role === 'pro' ? 1000 : (role === 'starter' ? 100 : 5);

      if (usageData && usageData.images_generated >= limit) {
        return res.status(403).json({
          error: 'Limite de gera√ß√£o atingido.',
          quotaStatus: 'BLOCKED',
          usage: usageData.images_generated,
          plan: role
        });
      }
    }

    // 2. Construct Professional Prompt
    let basePrompt = `${promptInfo.companyName} - ${promptInfo.details}. Estilo: ${artStyle?.name || 'Realista'}. Alta qualidade, 8k, profissional, cores vibrantes.`;
    if (promptInfo.addressCity) basePrompt += ` Localiza√ß√£o: ${promptInfo.addressCity}, Brasil.`;
    if (promptInfo.phone) basePrompt += ` WhatsApp: ${promptInfo.phone}.`;

    console.log(`üé® Generating image for ${role} user:`, user.id);

    // 3. Generate Image
    const encodedPrompt = encodeURIComponent(basePrompt);
    const imageUrl = `https://image.pollinations.ai/prompt/${encodedPrompt}?width=1024&height=1024&nologo=true&seed=${Math.floor(Math.random() * 10000)}`;

    // 4. Save to Database
    const { data: savedImage, error: saveError } = await supabase
      .from('images')
      .insert({
        user_id: user.id,
        prompt: basePrompt,
        image_url: imageUrl,
        business_info: promptInfo
      })
      .select()
      .single();

    if (saveError) {
      console.error('‚ùå Database error:', saveError);
      throw saveError;
    }

    console.log('‚úÖ Image saved:', savedImage.id);

    // 5. Update Usage (only for non-unlimited users)
    if (!hasUnlimitedGeneration) {
      const { data: usageData } = await supabase
        .from('user_usage')
        .select('*')
        .eq('user_id', user.id)
        .single();

      if (usageData) {
        await supabase.from('user_usage').update({ images_generated: usageData.images_generated + 1 }).eq('user_id', user.id);
      } else {
        await supabase.from('user_usage').insert({ user_id: user.id, images_generated: 1 });
      }
      console.log('‚úÖ Usage updated');
    } else {
      console.log('‚ú® Unlimited generation - quota not updated');
    }

    res.json({ image: savedImage });

  } catch (error) {
    console.error('‚ùå Generation error:', error);
    console.error('Error message:', error.message);
    if (error.details) console.error('Error details:', error.details);
    if (error.hint) console.error('Error hint:', error.hint);
    res.status(500).json({ error: 'Falha ao gerar imagem: ' + (error.message || 'Erro desconhecido') });
  }
});
